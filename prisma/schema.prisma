generator client {
  provider = "prisma-client"
  output   = "../backend/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model admins {
  id             String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email          String          @unique @db.VarChar(254)
  password       String          @db.VarChar(255)
  created_at     DateTime        @default(now()) @db.Timestamptz(6)
  updated_at     DateTime        @updatedAt @db.Timestamptz(6)
  refresh_tokens refresh_tokens[]
}

// Tabela de Refresh Tokens para autenticação segura
model refresh_tokens {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  admin_id   String   @db.Uuid
  token_hash String   @db.VarChar(255) // Hash do token (nunca armazena em texto puro)
  expires_at DateTime @db.Timestamptz(6)
  ip_address String?  @db.VarChar(45) // Suporta IPv6
  user_agent String?  @db.VarChar(500)
  is_revoked Boolean  @default(false)
  created_at DateTime @default(now()) @db.Timestamptz(6)
  
  admin admins @relation(fields: [admin_id], references: [id], onDelete: Cascade)
  
  @@index([admin_id])
  @@index([token_hash])
}

model products {
  id          String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name        String      @db.VarChar(100)
  category    String      @db.VarChar(50)
  price       Decimal     @db.Decimal(10, 2)
  featured    Boolean
  created_at  DateTime    @default(now()) @db.Timestamptz(6)
  updated_at  DateTime    @updatedAt @db.Timestamptz(6)
  description String?     @db.VarChar(500)
  size        ProductSize
  image       Bytes
}

model orders {
  id                   String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  externalReference    String         @unique
  customerName         String         @db.VarChar(100)
  customerEmail        String         @db.VarChar(254)
  customerPhone        String         @db.VarChar(20)
  customerCpf          String         @db.VarChar(14)
  addressStreet        String         @db.VarChar(100)
  addressNumber        String         @db.VarChar(20)
  addressComplement    String?        @db.VarChar(100)
  addressNeighborhood  String         @db.VarChar(50)
  addressCity          String         @db.VarChar(50)
  addressState         String         @db.VarChar(2)
  addressZip           String         @db.VarChar(10)
  addressReference     String?        @db.VarChar(100)
  addressType          String         @db.VarChar(20)
  deliveryNotes        String?        @db.VarChar(500)
  items                Json
  cakeSize             String?        @db.VarChar(20)
  subtotal             Decimal        @db.Decimal(10, 2)
  deliveryPrice        Decimal        @db.Decimal(10, 2)
  totalPrice           Decimal        @db.Decimal(10, 2)
  paymentMethod        PaymentMethod
  paymentStatus        PaymentStatus  @default(PENDING)
  deliveryStatus       DeliveryStatus @default(PENDING)
  deliveredAt          DateTime?      @db.Timestamptz(6)
  mercadoPagoPaymentId String?        @unique @db.VarChar(255)
  cardLastFour         String?        @db.VarChar(4)
  installments         Int?           @default(1)
  created_at           DateTime       @default(now()) @db.Timestamptz(6)
  updated_at           DateTime       @updatedAt @db.Timestamptz(6)
  whatsappSentAt       DateTime?      @db.Timestamptz(6)
}

model payments {
  id                String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  orderExternalRef  String
  mercadoPagoId     String        @unique @db.VarChar(255)
  status            PaymentStatus
  statusDetail      String?       @db.VarChar(255)
  transactionAmount Decimal       @db.Decimal(10, 2)
  paymentMethodId   String        @db.VarChar(50)
  webhookData       Json?
  created_at        DateTime      @default(now()) @db.Timestamptz(6)
  updated_at        DateTime      @updatedAt @db.Timestamptz(6)
}

enum ProductSize {
  PEQUENO
  MEDIO
  GRANDE
}

enum PaymentStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

enum PaymentMethod {
  PIX
  CREDIT_CARD
  WHATSAPP
}

enum DeliveryStatus {
  PENDING
  DELIVERED
}

// Configurações de frete baseado em distância
model delivery_config {
  id             String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  originCep      String   @db.VarChar(10)
  originAddress  String   @db.VarChar(200)
  originNumber   String   @db.VarChar(20)
  originNeighborhood String @db.VarChar(100)
  originCity     String   @db.VarChar(100)
  originState    String   @db.VarChar(2)
  originLat      Decimal? @db.Decimal(10, 8)
  originLng      Decimal? @db.Decimal(11, 8)
  isActive       Boolean  @default(true)
  created_at     DateTime @default(now()) @db.Timestamptz(6)
  updated_at     DateTime @updatedAt @db.Timestamptz(6)
  
  delivery_ranges delivery_ranges[]
}

// Faixas de preço por distância
model delivery_ranges {
  id              String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  delivery_config_id String       @db.Uuid
  minKm           Decimal         @db.Decimal(5, 2)
  maxKm           Decimal         @db.Decimal(5, 2)
  price           Decimal         @db.Decimal(10, 2)
  created_at      DateTime        @default(now()) @db.Timestamptz(6)
  updated_at      DateTime        @updatedAt @db.Timestamptz(6)
  
  delivery_config delivery_config @relation(fields: [delivery_config_id], references: [id], onDelete: Cascade)
  
  @@index([delivery_config_id])
}
